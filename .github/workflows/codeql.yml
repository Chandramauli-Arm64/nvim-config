name: Luacheck

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  luacheck:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lua-version: [5.1, 5.4] # Add more Lua versions if needed

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v5

      # Setup Lua using the modern GH Actions Lua setup
      - name: Setup Lua
        uses: leafo/gh-actions-lua@v11
        with:
          lua-version: ${{ matrix.lua-version }}
          luarocks: true # automatically installs LuaRocks

      # Cache Luacheck installation
      - name: Cache Luacheck
        id: cache-luacheck
        uses: actions/cache@v4
        with:
          path: ${{ env.LUAROCKS_CONFIG_HOME }}/lib/luarocks/rocks-*/luacheck
          key: luacheck-${{ matrix.lua-version }}-${{ hashFiles('**/luacheck*.rockspec') }}
          restore-keys: |
            luacheck-${{ matrix.lua-version }}-

      # Install Luacheck if not cached
      - name: Install Luacheck
        if: steps.cache-luacheck.outputs.cache-hit != 'true'
        run: luarocks install luacheck

      # Run Luacheck and generate SARIF report
      - name: Run Luacheck
        run: luacheck . --formatter sarif --output luacheck-results.sarif
        continue-on-error: true

      # Upload SARIF report to GitHub Code Scanning
      - name: Upload SARIF report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: luacheck-results.sarif
          category: luacheck
